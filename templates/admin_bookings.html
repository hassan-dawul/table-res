{% extends "base.html" %}
{% block title %}ğŸ“‹ Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø·Ø§Ø¹Ù… - Ø§Ù„Ø£Ø¯Ù…Ù†{% endblock %}

{% block content %}
<section class="py-5">
  <div class="container">
    <h2 class="mb-4 text-center" id="bookings-title">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h2>

    <div class="table-responsive">
      <table class="table table-bordered table-striped text-center align-middle" id="bookings-table">
        <thead class="table-primary">
          <tr>
            <th id="table-id">Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²</th>
            <th id="table-restaurant">Ø§Ù„Ù…Ø·Ø¹Ù…</th>
            <th id="table-user">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
            <th id="table-date">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th id="table-time">Ø§Ù„ÙˆÙ‚Øª</th>
            <th id="table-people">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ</th>
            <th id="table-status">Ø§Ù„Ø­Ø§Ù„Ø©</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="7" id="loading-text">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù…Ø®ÙÙŠØ© -->
<p class="d-none" id="status-confirmed">Ù…Ø¤ÙƒØ¯</p>
<p class="d-none" id="status-cancelled">Ù…Ù„ØºÙŠ</p>
<p class="d-none" id="status-pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±"</p>
<p class="d-none" id="no-bookings">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
<p class="d-none" id="error-loading-bookings">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª.</p>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const tableBody = document.querySelector("#bookings-table tbody");
    const paginationDiv = document.createElement('div');
    paginationDiv.className = 'mt-3 text-center';
    tableBody.parentElement.parentElement.appendChild(paginationDiv); // ØªØ­Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„

    let currentPage = 1;
    let totalPages = 1;
    const perPage = 40;

    async function loadBookings(page = 1) {
        currentPage = page;
        tableBody.innerHTML = `<tr><td colspan="7">${document.getElementById('loading-text')?.textContent || 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...'}</td></tr>`;

        try {
            const lang = localStorage.getItem('site-lang') || 'ar';
            const token = localStorage.getItem('admin-token');
            const res = await fetch(`/api/admin/bookings?lang=${lang}&page=${page}&per_page=${perPage}`, {
                credentials: "same-origin",
                headers: { "Authorization": `Bearer ${token}` }
            });
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            const result = await res.json();

            if (!result.data || result.data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7">${document.getElementById('no-bookings')?.textContent}</td></tr>`;
                paginationDiv.innerHTML = '';
                return;
            }

            totalPages = result.total_pages || 1;

            const statusTranslation = {
                "confirmed": document.getElementById('status-confirmed')?.textContent || "Ù…Ø¤ÙƒØ¯",
                "cancelled": document.getElementById('status-cancelled')?.textContent || "Ù…Ù„ØºÙŠ",
                "pending": document.getElementById('status-pending')?.textContent || "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±"
            };

            tableBody.innerHTML = "";
            result.data.forEach(b => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${b.id}</td>
                    <td>${b.restaurant_name}</td>
                    <td>${b.user_name}</td>
                    <td>${b.date}</td>
                    <td>${b.time}</td>
                    <td>${b.people}</td>
                    <td>${statusTranslation[b.status] || b.status}</td>
                `;
                tableBody.appendChild(row);
            });

            // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ùˆ Ø§Ù„ØªØ§Ù„ÙŠ Ù…Ø¹ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØµÙØ­Ø§Øª
            let html = `
                <button class="btn btn-sm btn-outline-primary mx-1 mb-1" ${currentPage === 1 ? 'disabled' : ''} id="prevPage">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
            `;

            // Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØµÙØ­Ø§Øª (Ù…Ø«Ù„Ø§Ù‹ Ù†Ø¹Ø±Ø¶ Ù…Ù† 1 Ø¥Ù„Ù‰ totalPages)
            for (let i = 1; i <= totalPages; i++) {
                html += `<button class="btn btn-sm btn-outline-primary mx-1 mb-1 page-btn" data-page="${i}" ${i === currentPage ? 'disabled' : ''}>${i}</button>`;
            }

            html += `<button class="btn btn-sm btn-outline-primary mx-1 mb-1" ${currentPage === totalPages ? 'disabled' : ''} id="nextPage">Ø§Ù„ØªØ§Ù„ÙŠ</button>`;

            paginationDiv.innerHTML = html;

            document.getElementById('prevPage')?.addEventListener('click', () => {
                if (currentPage > 1) loadBookings(currentPage - 1);
            });
            document.getElementById('nextPage')?.addEventListener('click', () => {
                if (currentPage < totalPages) loadBookings(currentPage + 1);
            });

            document.querySelectorAll('.page-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const pageNum = parseInt(btn.getAttribute('data-page'));
                    loadBookings(pageNum);
                });
            });

        } catch (err) {
            console.error(err);
            tableBody.innerHTML = `<tr><td colspan="7" class="text-danger">${document.getElementById('error-loading-bookings')?.textContent}</td></tr>`;
            paginationDiv.innerHTML = '';
        }
    }

    loadBookings();
});

</script>
{% endblock %}
