{% extends "base.html" %}
{% block title %}Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø·Ø§Ø¹Ù… - Ø§Ù„Ø£Ø¯Ù…Ù†{% endblock %}

{% block content %}
<section class="py-5">
  <div class="container">
    <h2 class="mb-4 text-center">ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h2>

    <div class="table-responsive">
      <table class="table table-bordered table-striped text-center align-middle">
        <thead class="table-primary">
          <tr>
            <th>Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²</th>
            <th>Ø§Ù„Ù…Ø·Ø¹Ù…</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„ÙˆÙ‚Øª</th>
            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody id="bookings-table">
          <tr>
            <td colspan="7">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const tableBody = document.getElementById("bookings-table");

    try {
      // âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†ÙØ³ Ø§Ù„Ø¬Ù„Ø³Ø©ØŒ Ø³ÙŠØ£Ø®Ø° Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù† Ø§Ù„ÙƒÙˆÙƒÙŠØ² ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
      const res = await fetch("/api/admin/bookings", {
        credentials: "same-origin"
      });

      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }

      const result = await res.json();

      if (!result.data || result.data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="7">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</td></tr>`;
        return;
      }

      // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª: Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§Ù„Ù…Ø§Ø¶ÙŠØŒ Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
      result.data.sort((a, b) => {
        const now = new Date();
        const dateA = new Date(a.date + ' ' + a.time);
        const dateB = new Date(b.date + ' ' + b.time);

        const aFuture = dateA >= now ? 0 : 1;
        const bFuture = dateB >= now ? 0 : 1;

        if (aFuture !== bFuture) return aFuture - bFuture; // Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ø£ÙˆÙ„Ø§Ù‹
        return dateB - dateA; // Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
      });

      tableBody.innerHTML = "";
      result.data.forEach(b => {
        const row = `
          <tr>
            <td>${b.id}</td>
            <td>${b.restaurant_name}</td>
            <td>${b.date}</td>
            <td>${b.time}</td>
            <td>${b.people}</td>
            <td>${b.status === "confirmed" ? "Ù…Ø¤ÙƒØ¯" : "Ù…Ù„ØºÙŠ"}</td>
            <td>${b.created_at.split("T")[0]}</td>
          </tr>`;
        tableBody.insertAdjacentHTML("beforeend", row);
      });

    } catch (err) {
      console.error(err);
      tableBody.innerHTML = `<tr><td colspan="7">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª.</td></tr>`;
    }
  });
</script>
{% endblock %}
