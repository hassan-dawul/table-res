{% extends "base.html" %}
{% block title %}حجز طاولة{% endblock %}
{% block content %}

<style>
    body {
        background: #f5f5f5;
        font-family: Arial, sans-serif;
        padding: 20px;
    }

    .booking-container {
        max-width: 1000px;
        margin: 50px auto;
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }

    .restaurant-info {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .divider {
        border-left: 2px solid #ddd;
        height: 100%;
    }
</style>

<div class="booking-container">
    <div class="row">
        <!-- قسم المطعم -->
        <div class="col-md-5">
            <div id="restaurantInfo" class="restaurant-info text-center">
                <p>جاري تحميل بيانات المطعم...</p>
            </div>
        </div>

        <!-- فاصل -->
        <div class="col-md-1 d-none d-md-flex justify-content-center">
            <div class="divider"></div>
        </div>

        <!-- قسم الحجز -->
        <div class="col-md-6">
            <h2 class="text-center mb-4">حجز طاولة</h2>

            <form id="bookingForm">
                <div class="mb-3">
                    <label for="date" class="form-label">التاريخ:</label>
                    <input type="date" class="form-control" id="date" name="date" required>
                </div>

                <div class="mb-3">
                    <label for="time" class="form-label">الوقت:</label>
                    <select id="time" name="time" class="form-select" required style="height: 45px;">
                        <option value="">اختر الساعة</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="people" class="form-label">عدد الأشخاص:</label>
                    <input type="number" class="form-control" id="people" name="people" min="1" required>
                </div>

                <button type="submit" class="btn btn-primary w-100">احجز الآن</button>
            </form>

            <div id="message" class="mt-3"></div>
        </div>
    </div>
</div>

<script>
    const select = document.getElementById('time');

    for (let h = 10; h <= 23; h++) {
        const period = h < 12 ? 'AM' : 'PM';
        const hour12 = h % 12 === 0 ? 12 : h % 12;

        const option = document.createElement('option');
        option.value = h.toString().padStart(2, '0') + ':00';  // القيمة للـ backend بصيغة 24 ساعة
        option.textContent = `${hour12} ${period}`;            // النص المعروض للمستخدم
        select.appendChild(option);
    }
</script>


<script>

    const form = document.getElementById('bookingForm');
    const message = document.getElementById('message');
    const infoDiv = document.getElementById('restaurantInfo');

    const restaurantId = "{{ restaurant_id }}";
    const restaurantIdNum = parseInt(restaurantId);

    // جلب بيانات المطعم
    async function loadRestaurant(id) {
        try {
            const res = await fetch(`/restaurants/${id}`);
            const data = await res.json();
            if (data.status === "success") {
                const r = data.data;
                infoDiv.innerHTML = `
                    <h3>${r.name}</h3>
                    <p class="text-muted">${r.cuisine} • ${r.area}</p>
                    <p>يفتح من <strong>${r.opens_at}</strong> إلى <strong>${r.closes_at}</strong></p>
                    <p>السعة: ${r.capacity} شخص</p>
                `;
            } else {
                infoDiv.innerHTML = `<div class="alert alert-danger">المطعم غير موجود</div>`;
            }
        } catch (err) {
            console.error(err);
            infoDiv.innerHTML = `<div class="alert alert-danger">حدث خطأ أثناء تحميل بيانات المطعم</div>`;
        }
    }

    loadRestaurant(restaurantIdNum);

    // إرسال بيانات الحجز
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const data = {
            date: formData.get('date'),
            time: formData.get('time'),
            people: parseInt(formData.get('people')),
            restaurant_id: restaurantIdNum
        };

        try {
            const res = await fetch('/bookings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                credentials: 'include'  // ← هذا يرسل الكوكيز مع الطلب
            });


            const result = await res.json();
            message.innerHTML = "";

            if (result.status === "success") {
                message.innerHTML = `
                    <div class="alert alert-success mt-3">
                        ✅ تم تأكيد الحجز بتاريخ ${result.date} الساعة ${result.time} لعدد ${result.people} أشخاص.
                    </div>`;
                form.reset();
            } else {
                message.innerHTML = `
                    <div class="alert alert-danger mt-3">
                        ⚠️ ${result.detail || "حدث خطأ أثناء تنفيذ الحجز"}
                    </div>`;
            }

        } catch (err) {
            console.error(err);
            message.innerHTML = `<div class="alert alert-danger mt-3">⚠️ خطأ في الاتصال بالخادم</div>`;
        }
    });
</script>

{% endblock %}