{% extends "base.html" %}
{% block title %}<span id="bookingTitle">Ø­Ø¬Ø² Ø·Ø§ÙˆÙ„Ø©</span>{% endblock %}
{% block content %}

<style>
    body {
        background: #f5f5f5;
        font-family: Arial, sans-serif;
        padding: 20px;
    }

    .booking-container {
        max-width: 1000px;
        margin: 50px auto;
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }

    .restaurant-info {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .divider {
        border-left: 2px solid #ddd;
        height: 100%;
    }
</style>

<div class="booking-container">
    <div class="row">
        <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù… -->
        <div class="col-md-5">
            <div id="restaurantInfo" class="restaurant-info text-center">
                <p id="loadingRestaurant">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ø¹Ù…...</p>
            </div>
        </div>

        <!-- ÙØ§ØµÙ„ -->
        <div class="col-md-1 d-none d-md-flex justify-content-center">
            <div class="divider"></div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø­Ø¬Ø² -->
        <div class="col-md-6">
            <h2 class="text-center mb-4" id="bookingSectionTitle">Ø­Ø¬Ø² Ø·Ø§ÙˆÙ„Ø©</h2>

            <form id="bookingForm">
                <div class="mb-3">
                    <label for="date" class="form-label" id="dateLabel">Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" class="form-control" id="date" name="date" required>
                </div>

                <div class="mb-3">
                    <label for="time" class="form-label" id="timeLabel">Ø§Ù„ÙˆÙ‚Øª:</label>
                    <select id="time" name="time" class="form-select" required style="height: 45px;">
                        <option value="" id="timePlaceholder">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¹Ø©</option>
                    </select>
                    <div id="availabilityInfo" class="mt-2 text-dark fw-bold"></div>

                </div>

                <div class="mb-3">
                    <label for="people" class="form-label" id="peopleLabel">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ:</label>
                    <input type="number" class="form-control" id="people" name="people" min="1" required>
                </div>

                <button type="submit" class="btn btn-primary w-100" id="submitBtn">Ø§Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†</button>
            </form>

            <div id="message" class="mt-3"></div>
        </div>
    </div>
</div>

<!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù…Ø®ÙÙŠØ© -->
<p class="d-none" id="restaurantNameLabel">Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù…</p>
<p class="d-none" id="restaurantCuisineLabel">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø·Ø¨Ø®</p>
<p class="d-none" id="restaurantAreaLabel">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</p>
<p class="d-none" id="restaurantHoursLabel">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</p>
<p class="d-none" id="restaurantCapacityLabel">Ø§Ù„Ø³Ø¹Ø©</p>
<p class="d-none" id="restaurantNotFound">Ø§Ù„Ù…Ø·Ø¹Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</p>
<p class="d-none" id="restaurantLoadError">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ø¹Ù…</p>
<p class="d-none" id="bookingSuccess">âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² Ø¨ØªØ§Ø±ÙŠØ® {date} Ø§Ù„Ø³Ø§Ø¹Ø© {time} Ù„Ø¹Ø¯Ø¯ {people} Ø£Ø´Ø®Ø§Øµ.</p>
<p class="d-none" id="bookingError">âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø¬Ø²</p>
<p class="d-none" id="connectionError">âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…</p>

<script>
    const select = document.getElementById('time');

    for (let h = 10; h <= 23; h++) {
        const period = h < 12 ? 'AM' : 'PM';
        const hour12 = h % 12 === 0 ? 12 : h % 12;

        const option = document.createElement('option');
        option.value = h.toString().padStart(2, '0') + ':00';
        option.textContent = `${hour12} ${period}`;
        select.appendChild(option);
    }
</script>

<script>
    const form = document.getElementById('bookingForm');
    const message = document.getElementById('message');
    const infoDiv = document.getElementById('restaurantInfo');

    const restaurantId = "{{ restaurant_id }}";
    const restaurantIdNum = parseInt(restaurantId);
    const lang = localStorage.getItem('site-lang') || 'ar';

    function translateText(id) {
        const el = document.getElementById(id);
        return el ? el.textContent : '';
    }

    async function loadRestaurant(id) {
        infoDiv.innerHTML = `<p>${translateText('loadingRestaurant')}</p>`;
        try {
            const lang = localStorage.getItem('site-lang') || 'ar';
            const res = await fetch(`/restaurants/${id}?lang=${lang}`);
            const data = await res.json();
            if (data.status === "success") {
                const r = data.data;
                infoDiv.innerHTML = `
                    <h3>${r.name}</h3>
                    <p class="text-muted">${r.cuisine} â€¢ ${r.area}</p>
                    <p>${translateText('restaurantHoursLabel')}: ${r.opens_at} - ${r.closes_at}</p>
                    <p id="restaurantCapacityValue">
    ${translateText('restaurantCapacityLabel')}: ${r.capacity} ${lang === 'ar' ? 'Ø´Ø®Øµ' : 'guests'}
</p>

                `;
            } else {
                infoDiv.innerHTML = `<div class="alert alert-danger">${translateText('restaurantNotFound')}</div>`;
            }
        } catch (err) {
            console.error(err);
            infoDiv.innerHTML = `<div class="alert alert-danger">${translateText('restaurantLoadError')}</div>`;
        }
    }

    loadRestaurant(restaurantIdNum);

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        document.getElementById('submitBtn').disabled = true

        const formData = new FormData(form);
        const data = {
            date: formData.get('date'),
            time: formData.get('time'),
            people: parseInt(formData.get('people')),
            restaurant_id: restaurantIdNum,
            lang: lang
        };

        try {
            const res = await fetch('/bookings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                credentials: 'include'
            });

            const result = await res.json();
            message.innerHTML = "";

            if (result.status === "success") {
                message.innerHTML = `<div class="alert alert-success mt-3">${translateText('bookingSuccess').replace('{date}', result.date).replace('{time}', result.time).replace('{people}', result.people)}</div>`;
                form.reset();
            } else {
                message.innerHTML = `<div class="alert alert-danger mt-3">${result.detail || translateText('bookingError')}</div>`;
            }
        } catch (err) {
            console.error(err);
            message.innerHTML = `<div class="alert alert-danger mt-3">${translateText('connectionError')}</div>`;
        } finally {
            document.getElementById('submitBtn').disabled = false
        }
    });
const dateInput = document.getElementById('date');
const timeInput = document.getElementById('time');
const availabilityDiv = document.getElementById('availabilityInfo');

async function checkAvailability() {
    const date = dateInput.value;
    const time = timeInput.value;

    // Ø¥Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø£Ùˆ Ø§Ù„ÙˆÙ‚Øª ÙØ§Ø±ØºØŒ Ù†Ù…Ø³Ø­ Ø§Ù„Ù†Øµ
    if (!date || !time) {
        availabilityDiv.textContent = "";
        return;
    }

    try {
        const res = await fetch(`/availability?restaurant_id=${restaurantIdNum}&date=${date}&time=${time}`);
        const data = await res.json();

        availabilityDiv.style.color = "black"; // Ø§Ù„Ù†Øµ Ø¯Ø§ÙŠÙ… Ø£Ø³ÙˆØ¯

        if (data.status === "success") {
            const remaining = data.remaining;
            if (remaining > 0) {
                availabilityDiv.innerHTML = translateText('availabilityRemaining').replace('{remaining}', remaining);
            } else {
                availabilityDiv.innerHTML = translateText('availabilityFull');
            }
        } else {
            availabilityDiv.innerHTML = translateText('availabilityCheckError');
        }

    } catch (err) {
        console.error(err);
        availabilityDiv.style.color = "black";
        availabilityDiv.innerHTML = translateText('availabilityConnectionError');
    }
}

// ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙØ­Øµ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ§Ø±ÙŠØ® Ø£Ùˆ Ø§Ù„ÙˆÙ‚Øª
dateInput.addEventListener('change', checkAvailability);
timeInput.addEventListener('change', checkAvailability);


</script>
<!-- RESTAURANTS SECTION -->
<section class="brand-bg py-5" id="restaurants-section">
  <div class="container">
    <h2 id="restaurants-title" class="mb-4 text-center">Ø§Ù„Ù…Ø·Ø§Ø¹Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
    <div id="restaurants-container" class="row g-4"></div>
    <div class="text-center mt-4">
        <a id="more-restaurants-btn" href="/restaurants_page" class="btn btn-primary btn-lg">Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</a>
    </div>
  </div>
</section>

<script>
  $(document).ready(function() {
    const lang = localStorage.getItem('site-lang')
    const endpoint = '/restaurants?lang=' + lang;
    $.ajax({
      url: endpoint,
      method: 'GET',
      dataType: 'json',
      success: function(data) {
        $('#restaurants-container').empty();
        $.each(data.data, function(index, r) {
          const cardHtml = `
          <div class="col-md-4">
            <div class="card shadow-sm rounded">
              <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-1 fw-bold">${r.name}</h5>
                <small>${r.cuisine}</small>
              </div>
              <div class="card-body">
                                         <p class="mb-1"><strong>${document.getElementById('location')?.textContent || 'Ø§Ù„Ù…ÙˆÙ‚Ø¹'}:</strong> ${r.area }</p>
                         <p class="mb-1"><strong>${document.getElementById('hours')?.textContent || 'Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„'}:</strong> ${r.opens_at} - ${r.closes_at}</p>
                        <p><strong>${document.getElementById('capacity')?.textContent || 'Ø§Ù„Ø³Ø¹Ø©'}:</strong> ${r.capacity} ${document.getElementById('guests')?.textContent || 'Ø¶ÙŠÙ'}</p>
                        <p><strong>${document.getElementById('todayBookingsLabel')?.textContent || 'Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„ÙŠÙˆÙ…'}:</strong> ${r.today_bookings}</p>

                        </div>
                                <div class="card-footer text-center">
                          <button class="btn btn-warning fw-bold" onclick="window.location.href='/booking/${r.id}'">
                ${document.getElementById('bookNow')?.textContent || 'Ø§Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†'}

              </div>
            </div>
          </div>`;
          $('#restaurants-container').append(cardHtml);
        });
      },
      error: function(xhr, status, error) {
        $('#restaurants-container').html(`
          <div class="alert alert-danger text-center">
            <p>âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø·Ø§Ø¹Ù….</p>
            <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${status}</p>
            <p><strong>Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</strong> ${error}</p>
          </div>
        `);
      }
    });

  });
</script>

<!-- ğŸ”¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù…Ø®ÙÙŠØ© Ù„Ù„Ù…Ø·Ø§Ø¹Ù… -->
<p class="d-none" id="location"></p>
<p class="d-none" id="hours"></p>
<p class="d-none" id="capacity"></p>
<p class="d-none" id="bookNow"></p>
<p class="d-none" id="guests"></p>
<p class="d-none" id="todayBookingsLabel"></p>
<p class="d-none" id="availabilityRemaining">Ù…ØªØ¨Ù‚ÙŠ <strong>{remaining}</strong> Ø£Ù…Ø§ÙƒÙ† Ù„Ù„Ø­Ø¬Ø²</p>
<p class="d-none" id="availabilityFull">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù…Ø§ÙƒÙ† Ù…ØªØ§Ø­Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª</p>
<p class="d-none" id="availabilityCheckError">âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙØ±</p>
<p class="d-none" id="availabilityConnectionError">âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…</p>



{% endblock %}
