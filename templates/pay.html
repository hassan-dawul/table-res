{% extends "base.html" %}

{% block title %}إتمام الدفع{% endblock %}

{% block content %}
<div class="container mt-5 text-center">
    <h2>إتمام الدفع</h2>
    <p>سيتم معالجة الدفع بشكل آمن لإتمام حجزك.</p>

    <!-- عنصر الدفع -->
    <div id="checkout"></div>
    <div id="payment-message" class="mt-3"></div>
</div>

<!-- Stripe.js الرسمي -->
<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe("{{ publishable_key }}");

// تهيئة Embedded Checkout
const elements = stripe.elements();
const paymentElement = elements.create('payment');
paymentElement.mount('#checkout');

const form = document.createElement('form');
form.id = 'payment-form';
form.appendChild(paymentElement);
document.getElementById('checkout').appendChild(form);

form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const { error, paymentIntent } = await stripe.confirmPayment({
        elements,
        confirmParams: {
            return_url: window.location.origin + "/booking-success?booking_id={{ booking.id }}"
        },
    });

    const messageDiv = document.getElementById('payment-message');
    if (error) {
        messageDiv.textContent = error.message;
        messageDiv.className = "alert alert-danger mt-3";
    }
});
</script>
{% endblock %}
