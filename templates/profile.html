{% extends "base.html" %}
{% block title %}Ø­Ø¬Ø² Ø·Ø§ÙˆÙ„Ø©{% endblock %}
{% block content %}

<main class="container mt-5">
    <h2>Ù…Ø±Ø­Ø¨Ø§ Ø¨ÙƒØŒ <span id="fullname"></span></h2>
    <p>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: <span id="email"></span></p>
    <p>Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„: <span id="last_login"></span></p>
    <button id="logoutBtn" class="btn btn-danger mb-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

    <hr>

    <h3>Ø­Ø¬ÙˆØ²Ø§ØªÙŠ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©:</h3>
    <table class="table table-striped" id="bookingsTable">
        <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">Ø§Ù„Ù…Ø·Ø¹Ù…</th>
                <th scope="col">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th scope="col">Ø§Ù„ÙˆÙ‚Øª</th>
                <th scope="col">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ</th>
                <th scope="col">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th scope="col">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="bookingsList">
            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø¹Ø¨Ø± JavaScript -->
        </tbody>
    </table>
</main>

<script>
    // ==========================
    // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    // ==========================
    async function loadUserInfo() {
        try {
            const res = await fetch('/user', { credentials: 'include' });
            const data = await res.json();

            if (data.status === 'success') {
                document.getElementById('fullname').textContent = data.data.fullname;
                document.getElementById('email').textContent = data.data.email;
                document.getElementById('last_login').textContent = data.data.last_login;

                loadUserBookings();
            } else {
                window.location.href = '/login';
            }
        } catch (err) {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", err);
            window.location.href = '/login';
        }
    }

    // ==========================
    // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    // ==========================

    async function loadUserBookings() {
    const list = document.getElementById('bookingsList');
    list.innerHTML = '';

    // ğŸ”¹ 1ï¸âƒ£ Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ù…ÙˆØ³ ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø­Ø§Ù„Ø©
    const statusTranslation = {
        "confirmed": "Ù…Ø¤ÙƒØ¯",
        "cancelled": "Ù…Ù„ØºÙŠ"
    };

    try {
        const res = await fetch('/api/bookings', { credentials: 'include' });
        const result = await res.json();
        const bookings = result.data;

        if (bookings.length > 0) {
            bookings.forEach((b, index) => {
                let dateOnly = b.date.split('T')[0]; // Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø¯ÙˆÙ† Ø§Ù„ÙˆÙ‚Øª

                // ğŸ”¹ 3ï¸âƒ£ Ù…Ù†Ø¹ Ø¸Ù‡ÙˆØ± Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ù„Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ù„ØºÙŠØ©
                let actionBtn = '';
                if (b.status !== 'cancelled') {
                    actionBtn = `<button class="btn btn-outline-danger btn-sm fw-bold" onclick="cancelBooking(${b.id}, this)">
                                    Ø¥Ù„ØºØ§Ø¡
                                 </button>`;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <th scope="row">${index + 1}</th>
                    <td>${b.restaurant_name}</td>
                    <td>${dateOnly}</td>
                    <td>${b.time}</td>
                    <td>${b.people}</td>
                    <!-- ğŸ”¹ Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ -->
                    <td>${statusTranslation[b.status] || b.status}</td>
                    <td>${actionBtn}</td>
                `;
                list.appendChild(tr);
            });
        } else {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="7" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</td>`;
            list.appendChild(tr);
        }
    } catch (err) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª:", err);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="7" class="text-center text-danger">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª.</td>`;
        list.appendChild(tr);
    }
}


    // ==========================
    // ğŸ§¹ Ø¯Ø§Ù„Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²
    // ==========================
    async function cancelBooking(id, btn) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù„ØºØ§Ø¡ØŸ')) return;

        try {
            const res = await fetch(`/api/bookings/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            const data = await res.json();

            if (data.status === 'success') {
                //  ØªØ¹Ø¯ÙŠÙ„: Ù„Ø§ Ù†Ø­Ø°Ù Ø§Ù„ØµÙØŒ Ù†ØºÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© ÙÙ‚Ø· ÙˆÙ†Ø²ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
                const row = btn.closest('tr');
                row.querySelector('td:nth-child(6)').textContent = "Ù…Ù„ØºÙŠ"; // Ø§Ù„Ø¹Ù…ÙˆØ¯ 6 Ù‡Ùˆ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø²
                btn.remove(); // Ø¥Ø²Ø§Ù„Ø© Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù„ØºØ§Ø¡
                alert(`âœ… ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø¨Ù†Ø¬Ø§Ø­`);
            } else {
                alert(`âš ï¸ ${data.detail || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ù„ØºØ§Ø¡'}`);
            }
        } catch (error) {
            alert(`âš ï¸ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…`);
            console.error(error);
        }
    }

    // ==========================
    // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    // ==========================
    document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
            await fetch('/logout', { credentials: 'include' });
            window.location.href = '/login';
        } catch (err) {
            console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬:", err);
        }
    });

    loadUserInfo();
</script>

{% endblock %}
