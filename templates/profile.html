{% extends "base.html" %}
{% block title %}<span id="profile-title">Ø­Ø¬Ø² Ø·Ø§ÙˆÙ„Ø©</span>{% endblock %}
{% block content %}

<main class="container mt-5">
    <h2><span id="profile-welcome">Ù…Ø±Ø­Ø¨Ø§ Ø¨ÙƒØŒ</span> <span id="fullname"></span></h2>
    <p><span id="profile-email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</span> <span id="email"></span></p>
    <p><span id="profile-last-login">Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„:</span> <span id="last_login"></span></p>
    <button id="logoutBtn" class="btn btn-danger mb-4"><span id="profile-logout">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span></button>

    <hr>

    <h3 id="bookings-title">Ø­Ø¬ÙˆØ²Ø§ØªÙŠ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©:</h3>
    <table class="table table-striped" id="bookingsTable">
        <thead>
            <tr>
                <th id="table-id" scope="col">#</th>
                <th id="table-restaurant" scope="col">Ø§Ù„Ù…Ø·Ø¹Ù…</th>
                <th id="table-date" scope="col">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th id="table-time" scope="col">Ø§Ù„ÙˆÙ‚Øª</th>
                <th id="table-people" scope="col">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ</th>
                <th id="table-status" scope="col">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th id="table-actions" scope="col">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="bookingsList">
            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø¹Ø¨Ø± JavaScript -->
        </tbody>
    </table>

<!-- ğŸ”¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù…Ø®ÙÙŠØ© -->
<p class="d-none" id="profile-welcome"></p>
<p class="d-none" id="profile-email"></p>
<p class="d-none" id="profile-last-login"></p>
<p class="d-none" id="profile-logout"></p>
<p class="d-none" id="bookings-title"></p>
<p class="d-none" id="table-id"></p>
<p class="d-none" id="table-restaurant"></p>
<p class="d-none" id="table-date"></p>
<p class="d-none" id="table-time"></p>
<p class="d-none" id="table-people"></p>
<p class="d-none" id="table-status"></p>
<p class="d-none" id="table-actions"></p>
<p class="d-none" id="status-pending"></p>
<p class="d-none" id="status-cancelled"></p>
<p class="d-none" id=""></p>
<p class="d-none" id="no-bookings"></p>
<p class="d-none" id="error-loading-bookings"></p>
<p class="d-none" id="cancel-confirm"></p>
<p class="d-none" id="cancel-success"></p>
<p class="d-none" id="cancel-failed"></p>
<p class="d-none" id="logout-error"></p>
<p class="d-none" id="cancel-btn"></p>
<p class="d-none" id="pay-btn">Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†</p>


    
</main>

<script>
async function loadUserInfo() {
    try {
        const res = await fetch('/user', { credentials: 'include' });
        const data = await res.json();

        if (data.status === 'success') {
            document.getElementById('fullname').textContent = data.data.fullname;
            document.getElementById('email').textContent = data.data.email;
            document.getElementById('last_login').textContent = data.data.last_login;

            loadUserBookings();
        } else {
            window.location.href = '/login';
        }
    } catch (err) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", err);
        window.location.href = '/login';
    }
}

async function loadUserBookings() {
    const list = document.getElementById('bookingsList');
    list.innerHTML = '';

    const statusTranslation = {
        "confirmed": document.getElementById('status-confirmed')?.textContent || "Ù…Ø¤ÙƒØ¯",
        "cancelled": document.getElementById('status-cancelled')?.textContent || "Ù…Ù„ØºÙŠ",
        "pending": document.getElementById('status-pending')?.textContent || "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±"
    };

    try {
        const lang = localStorage.getItem('site-lang') || 'ar';
        const res = await fetch(`/api/bookings?lang=${lang}`, { credentials: 'include' });
        const result = await res.json();
        const bookings = result.data;

        if (bookings.length > 0) {
            bookings.forEach((b, index) => {
                let dateOnly = b.date.split('T')[0];

                // Ø²Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡
                let actionBtn = '';
if (b.status === 'pending') {

    // Ø²Ø± Ø§Ù„Ø¯ÙØ¹ â€“ Ø§Ù„Ù†Øµ ÙŠØ¬ÙŠ Ù…Ù† Ø¹Ù†ØµØ± Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù…Ø®ÙÙŠ
    actionBtn = `<button class="btn btn-primary btn-sm" onclick="window.location='/pay?s=${b.client_secret}'">
                    ${document.getElementById('pay-btn')?.textContent || 'Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†'}
                 </button>`;

} else if (b.status !== 'cancelled') {

    // Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ ÙƒÙ…Ø§ Ù‡Ùˆ
    actionBtn = `<button class="btn btn-outline-danger btn-sm fw-bold" onclick="cancelBooking(${b.id}, this)">
                    ${document.getElementById('cancel-btn')?.textContent || 'Ø¥Ù„ØºØ§Ø¡'}
                 </button>`;
}



                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <th scope="row">${index + 1}</th>
                    <td>${b.restaurant_name}</td>
                    <td>${dateOnly}</td>
                    <td>${b.time}</td>
                    <td>${b.people}</td>
                    <td>${statusTranslation[b.status] || b.status}</td>
                    <td>${actionBtn}</td>
                `;
                list.appendChild(tr);
            });
        } else {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="7" class="text-center">${document.getElementById('no-bookings')?.textContent || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.'}</td>`;
            list.appendChild(tr);
        }
    } catch (err) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª:", err);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="7" class="text-center text-danger">${document.getElementById('error-loading-bookings')?.textContent || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª.'}</td>`;
        list.appendChild(tr);
    }
}

async function cancelBooking(id, btn) {
    if (!confirm(document.getElementById('cancel-confirm')?.textContent || 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù„ØºØ§Ø¡ØŸ')) return;

    try {
        const res = await fetch(`/api/bookings/${id}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        const data = await res.json();

        if (data.status === 'success') {
            const row = btn.closest('tr');
            row.querySelector('td:nth-child(6)').textContent = document.getElementById('status-cancelled')?.textContent || "Ù…Ù„ØºÙŠ";
            btn.remove();
            alert(document.getElementById('cancel-success')?.textContent || "âœ… ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø¨Ù†Ø¬Ø§Ø­");
        } else {
            alert(`âš ï¸ ${data.detail || document.getElementById('cancel-failed')?.textContent || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ù„ØºØ§Ø¡'}`);
        }
    } catch (error) {
        alert(document.getElementById('logout-error')?.textContent || "âš ï¸ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…");
        console.error(error);
    }
}

document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
        await fetch('/logout', { credentials: 'include' });
        window.location.href = '/login';
    } catch (err) {
        console.error(document.getElementById('logout-error')?.textContent || "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬:", err);
    }
});

loadUserInfo();
</script>

{% endblock %}
