{% extends "base.html" %}
{% block title %}Ø§Ù„Ù…Ø·Ø§Ø¹Ù…{% endblock %}
{% block content %}

<!-- RESTAURANTS SECTION -->
<section class="brand-bg py-5" id="restaurants-section" style="background-color: #007BFF;">
    <div class="container">
        <h2 class="mb-4 text-center text-white" id="restaurants-title">Ø§Ù„Ù…Ø·Ø§Ø¹Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
        <div class="row">

            <!-- ====== Ø§Ù„ÙÙ„Ø§ØªØ± ====== -->
            <div class="col-md-3">
                <div class="card p-3 shadow-sm mb-4">
                    <h5 id="filters">Ø§Ù„ÙÙ„Ø§ØªØ±</h5>

                    <!-- Ø§Ù„Ø¨Ø­Ø« -->
                    <div class="mb-3 mt-2">
                        <div class="input-group">
                            <input type="text" id="restaurant-search" class="form-control form-control-sm" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø·Ø¹Ù…...">
                            <button id="search-btn" class="btn btn-primary btn-sm">Ø¨Ø­Ø«</button>
                        </div>
                    </div>

                    <!-- ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø·Ø¨Ø® -->
                    <div class="mb-3">
                        <h6 id="cuisineType">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø·Ø¨Ø®</h6>
                        <div id="cuisine-filters"></div>
                    </div>

                    <!-- ÙÙ„ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© -->
                    <div class="mb-3">
                        <h6 id="area">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</h6>
                        <div id="area-filters"></div>
                    </div>
                </div>
            </div>

            <!-- ====== Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø·Ø§Ø¹Ù… ====== -->
            <div class="col-md-9">
                <div class="row" id="restaurant-list">
                    <!-- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø³ØªÙØ¶Ø§Ù Ù‡Ù†Ø§ -->
                </div>

                <!-- Pagination -->
                <div class="text-center mt-3" id="restaurant-pagination"></div>
            </div>

        </div>
    </div>
</section>

<!-- ğŸ”¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù…Ø®ÙÙŠØ© Ù„Ù„Ù…Ø·Ø§Ø¹Ù… -->
<p class="d-none" id="location"></p>
<p class="d-none" id="hours"></p>
<p class="d-none" id="capacity"></p>
<p class="d-none" id="bookNow"></p>
<p class="d-none" id="restaurantsTitle"></p>
<p class="d-none" id="searchPlaceholder"></p>
<p class="d-none" id="area"></p>
<p class="d-none" id="all"></p>
<p class="d-none" id="workingHours"></p>
<p class="d-none" id="guests"></p>
<p class="d-none" id="errorFetch"></p>
<p class="d-none" id="errorFetchMsg"></p>
<p class="d-none" id="noRestaurantsMsg"></p>
<p class="d-none" id="todayBookingsLabel"></p>
<p class="d-none" id="pagination-prev"></p>
<p class="d-none" id="pagination-next"></p>

<script>
$(document).ready(function() {
    const restaurantList = document.getElementById("restaurant-list");
    const cuisineFiltersDiv = document.getElementById("cuisine-filters");
    const areaFiltersDiv = document.getElementById("area-filters");
    const searchInput = document.getElementById("restaurant-search");
    searchInput.placeholder = document.getElementById("searchPlaceholder")?.textContent || "Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø·Ø¹Ù…...";
    const searchBtn = document.getElementById("search-btn");
    const lang = localStorage.getItem('site-lang') || 'ar';

    // ğŸ”¹ Pagination variables
    let allRestaurants = [];
    let currentPage = 1;
    const restaurantsPerPage = 9;

    // ğŸ”¹ Fetch restaurants
    async function fetchRestaurants(searchQuery = "") {
        let cuisine = document.querySelector("input[name='cuisine']:checked")?.value || "";
        let area = document.querySelector("input[name='area']:checked")?.value || "";

        let apiUrl = `/restaurants?lang=${lang}`;
        if (cuisine) apiUrl += `&cuisine=${encodeURIComponent(cuisine)}`;
        if (area) apiUrl += `&area=${encodeURIComponent(area)}`;
        if (searchQuery) apiUrl += `&search=${encodeURIComponent(searchQuery)}`;

        try {
            const response = await fetch(apiUrl);
            const result = await response.json();

            allRestaurants = result.data || result;
            currentPage = 1;
            displayRestaurants(currentPage);

        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
            restaurantList.innerHTML = `<div class="text-center text-white"><p>${document.getElementById('errorFetchMsg')?.textContent || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ø§Ø¹Ù….'}</p></div>`;
        }
    }

    // ğŸ”¹ Display restaurants for a page
    function displayRestaurants(page) {
        restaurantList.innerHTML = "";
        currentPage = page;

        const start = (currentPage - 1) * restaurantsPerPage;
        const end = start + restaurantsPerPage;
        const restaurants = allRestaurants.slice(start, end);

        if (restaurants.length === 0) {
            restaurantList.innerHTML = `<p class="text-white text-center">${document.getElementById('noRestaurantsMsg')?.textContent || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø·Ø§Ø¹Ù… Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.'}</p>`;
            return;
        }

        restaurants.forEach(r => {
            const cardHtml = `
                <div class="col-md-4 mb-4">
                    <div class="card shadow-sm rounded h-100">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-1 fw-bold">${r.name}</h5>
                            <small>${r.cuisine}</small>
                        </div>
                        <div class="card-body">
                            <p class="mb-1"><strong>${document.getElementById('location')?.textContent || 'Ø§Ù„Ù…ÙˆÙ‚Ø¹'}:</strong> ${r.area}</p>
                            <p class="mb-1"><strong>${document.getElementById('hours')?.textContent || 'Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„'}:</strong> ${r.opens_at} - ${r.closes_at}</p>
                            <p><strong>${document.getElementById('capacity')?.textContent || 'Ø§Ù„Ø³Ø¹Ø©'}:</strong> ${r.capacity} ${document.getElementById('guests')?.textContent || 'Ø¶ÙŠÙ'}</p>
                            <p><strong>${document.getElementById('todayBookingsLabel')?.textContent || 'Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„ÙŠÙˆÙ…'}:</strong> ${r.today_bookings}</p>
                        </div>
                        <div class="card-footer text-center">
                            <button class="btn btn-warning fw-bold" onclick="window.location.href='/booking/${r.id}'">
                                ${document.getElementById('bookNow')?.textContent || 'Ø§Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†'}
                            </button>
                        </div>
                    </div>
                </div>`;
            restaurantList.insertAdjacentHTML("beforeend", cardHtml);
        });

        renderPagination();
    }

    // ğŸ”¹ Render Pagination buttons
    function renderPagination() {
        const paginationContainer = document.getElementById("restaurant-pagination");
        if (!paginationContainer) return;

        paginationContainer.innerHTML = "";
        const totalPages = Math.ceil(allRestaurants.length / restaurantsPerPage);

        if (totalPages <= 1) return;

        // Ø²Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚
        const prevBtn = document.createElement("button");
        prevBtn.textContent = document.getElementById('pagination-prev')?.textContent || "Ø§Ù„Ø³Ø§Ø¨Ù‚";
        prevBtn.className = "btn btn-light me-1";
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => displayRestaurants(currentPage - 1);
        paginationContainer.appendChild(prevBtn);

        // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙØ­Ø§Øª
        for (let i = 1; i <= totalPages; i++) {
            const pageBtn = document.createElement("button");
            pageBtn.textContent = i;
            pageBtn.className = `btn me-1 ${i === currentPage ? "btn-dark text-white" : "btn-light"}`;
            pageBtn.onclick = () => displayRestaurants(i);
            paginationContainer.appendChild(pageBtn);
        }

        // Ø²Ø± Ø§Ù„ØªØ§Ù„ÙŠ
        const nextBtn = document.createElement("button");
        nextBtn.textContent = document.getElementById('pagination-next')?.textContent || "Ø§Ù„ØªØ§Ù„ÙŠ";
        nextBtn.className = "btn btn-light";
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.onclick = () => displayRestaurants(currentPage + 1);
        paginationContainer.appendChild(nextBtn);
    }

    // ğŸ”¹ Load filters from API
    async function loadFilters() {
        try {
            const res = await fetch(`/restaurants/filters?lang=${lang}`);
            const data = await res.json();

            // ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø·Ø¨Ø®
            const allCuisine = document.createElement("div");
            allCuisine.className = "form-check";
            allCuisine.innerHTML = `
                <input class="form-check-input" type="radio" name="cuisine" value="" id="allCuisine" checked>
                <label class="form-check-label w-100" for="allCuisine">
                    ${document.getElementById('all')?.textContent || 'Ø§Ù„ÙƒÙ„'}
                </label>`;
            cuisineFiltersDiv.appendChild(allCuisine);

            data.filters.cuisines.forEach(c => {
                const div = document.createElement("div");
                div.className = "form-check";
                div.innerHTML = `
                    <input class="form-check-input" type="radio" name="cuisine" value="${c}" id="${c}">
                    <label class="form-check-label w-100" for="${c}">${c}</label>`;
                cuisineFiltersDiv.appendChild(div);
            });

            // ÙÙ„ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
            const allArea = document.createElement("div");
            allArea.className = "form-check";
            allArea.innerHTML = `
                <input class="form-check-input" type="radio" name="area" value="" id="allArea" checked>
                <label class="form-check-label w-100" for="allArea">
                    ${document.getElementById('all')?.textContent || 'Ø§Ù„ÙƒÙ„'}
                </label>`;
            areaFiltersDiv.appendChild(allArea);

            data.filters.areas.forEach(a => {
                const div = document.createElement("div");
                div.className = "form-check";
                div.innerHTML = `
                    <input class="form-check-input" type="radio" name="area" value="${a}" id="${a}">
                    <label class="form-check-label w-100" for="${a}">${a}</label>`;
                areaFiltersDiv.appendChild(div);
            });

            // ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙÙ„Ø§ØªØ±
            document.querySelectorAll("input[name='cuisine'], input[name='area']").forEach(radio => {
                radio.addEventListener("change", () => fetchRestaurants(searchInput.value.trim()));
            });

        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ±:", error);
            cuisineFiltersDiv.innerHTML = `<p class="text-danger">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙ„Ø§ØªØ±.</p>`;
        }
    }

    // ğŸ”¹ Search button
    searchBtn.addEventListener("click", () => {
        fetchRestaurants(searchInput.value.trim());
    });

    // ğŸ”¹ Enter key search
    searchInput.addEventListener("keyup", (e) => {
        if (e.key === "Enter") fetchRestaurants(searchInput.value.trim());
    });

    // ğŸ”¹ Load filters and restaurants
    loadFilters().then(() => fetchRestaurants());
});
</script>

{% endblock %}
